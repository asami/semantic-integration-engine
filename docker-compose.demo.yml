version: "3.9"

services:

  #######################################################################
  # FUSEKI — RDF / SPARQL server
  #######################################################################
  fuseki:
    image: ghcr.io/asami/preload-fuseki:latest
    container_name: sie-fuseki
    platform: linux/amd64
    ports:
      - "9030:3030"
    restart: unless-stopped
    networks:
      - sie-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/ds/query?query=SELECT%20*%20WHERE%20%7B%20?s%20?p%20?o%20%7D%20LIMIT%201"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  #######################################################################
  # SIE-EMBEDDING — Lightweight embedding service
  #######################################################################
  sie-embedding:
    image: ghcr.io/asami/sie-embedding:latest
    container_name: sie-embedding
    ports:
      - "8081:8081"
    restart: unless-stopped
    networks:
      - sie-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 3s
      timeout: 2s
      retries: 20

  #######################################################################
  # SIE — Semantic Integration Engine (HTTP + MCP WebSocket)
  #######################################################################
  sie:
    image: ghcr.io/asami/sie:0.0.4
    command:
      - "java"
      - "-Dconfig.file=/app/conf/application.demo.conf"
      - "-jar"
      - "/app/semantic-integration-engine.jar"
    container_name: sie
    depends_on:
      fuseki:
        condition: service_healthy
      sie-embedding:
        condition: service_healthy

    ports:
      - "9050:9050"   # HTTP RAG API
      - "9051:9051"   # MCP WebSocket API

    environment:
      # ---- SIE configuration ----
      FUSEKI_URL: http://sie-fuseki:3030/ds
      SIE_EMBEDDING_MODE: "oss"
      SIE_OSS_EMBEDDING_URL: http://sie-embedding:8081/embed

      # ---- MCP WebSocket port ----
      SIE_MCP_PORT: 9051

    restart: unless-stopped
    networks:
      - sie-net


networks:
  sie-net:
