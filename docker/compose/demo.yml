version: "3.9"

services:

  #######################################################################
  # FUSEKI — RDF / SPARQL server
  #######################################################################
  fuseki:
    image: ghcr.io/asami/preload-fuseki:latest
    container_name: sie-fuseki
    platform: linux/amd64
    ports:
      - "9030:3030"
    restart: unless-stopped
    networks:
      - sie-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/ds/query?query=SELECT%20*%20WHERE%20%7B%20?s%20?p%20?o%20%7D%20LIMIT%201"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  #######################################################################
  # SIE-EMBEDDING — Lightweight embedding service
  #######################################################################
  sie-embedding:
    image: ghcr.io/asami/sie-embedding:latest
    container_name: sie-embedding
    ports:
      - "8081:8081"
    restart: unless-stopped
    networks:
      - sie-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 3s
      timeout: 2s
      retries: 20

  #######################################################################
  # SIE — Semantic Integration Engine (Demo)
  #
  # NOTE:
  # - This demo explicitly uses application.demo.conf.
  # - Do NOT rely on the image default ENTRYPOINT/CMD for demo behavior.
  # - This preserves the historical demo behavior from docker-compose.demo.yml.
  #######################################################################
  sie:
    image: ghcr.io/asami/sie:0.1.0-SNAPSHOT.g
    container_name: sie
    volumes:
      - .:/workspace/vscode-mcp
    depends_on:
      fuseki:
        condition: service_healthy
      sie-embedding:
        condition: service_healthy

    ports:
      - "9050:9050"   # HTTP + MCP WebSocket API (/mcp)

    environment:
      SIE_MODE: demo
      # ---- Application server mode (required) ----
      SERVER_MODE: demo
      # ---- MCP / VS Code workspace ----
      SIE_WORKSPACE_DIR: /workspace/vscode-mcp
      # ---- SIE configuration ----
      FUSEKI_URL: http://sie-fuseki:3030/ds
      SIE_EMBEDDING_MODE: "oss"
      SIE_EMBEDDING_ENDPOINT: http://sie-embedding:8081/embed

    command:
      - java
      - -Dconfig.file=/app/conf/application.demo.conf
      - -jar
      - /app/semantic-integration-engine.jar

    restart: unless-stopped
    networks:
      - sie-net

  #######################################################################
  # SIE-MCP — MCP stdio client (transient, non-daemon)
  #######################################################################
  sie-mcp:
    image: ghcr.io/asami/sie:0.1.0-SNAPSHOT.a
    container_name: sie-mcp
    entrypoint: ["/opt/sie/bin/mcp-client"]
    stdin_open: true
    tty: false
    depends_on:
      sie:
        condition: service_started
    environment:
      MCP_WS_URL: ws://sie:9050/mcp
    networks:
      - sie-net


networks:
  sie-net:
