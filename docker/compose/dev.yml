# ============================================================
# docker-compose.dev.yml
#
# DEV Environment – External Dependencies Only
# ============================================================
#
# Operational model:
#
#   - SIE (Semantic Integration Engine) runs OUTSIDE Docker
#     on the local JVM via:
#
#         $ sbt dev
#
#   - This compose file provides ONLY external dependencies
#     required by SIE in DEV mode.
#
# Components:
#
#   - GraphDB : Apache Jena Fuseki (RDF / Knowledge Graph)
#   - VectorDB / Embedding : sie-embedding (Chroma PersistentClient)
#
# Connection model:
#
#   SIE (local JVM)
#     ├─ Fuseki       → http://localhost:9030/ds
#     └─ sie-embedding→ http://localhost:8081
#
# Initialization policy (DEV):
#
#   - GraphDB (Fuseki):
#       * Initialized by `init-fuseki` container.
#       * If data already exists under ./fuseki/databases,
#         it is reused as-is.
#       * SIE treats GraphDB as a REQUIRED dependency
#         and fails fast if it is unreachable or empty.
#
#   - VectorDB (sie-embedding / Chroma):
#       * Persistent data stored under ./chroma-data.
#       * If data exists, it is reused.
#       * If empty, SIE performs lazy / background initialization.
#       * Absence of VectorDB data is NOT a startup error in DEV.
#
# Design notes:
#
#   - SIE itself MUST NOT be started by docker-compose.dev.yml.
#   - This separation enables fast iteration, debugging,
#     and safe reset of local knowledge stores.
#
# ============================================================
services:

  # ------------------------------------------------------------
  # GraphDB: Apache Jena Fuseki
  # ------------------------------------------------------------
  fuseki:
    image: stain/jena-fuseki:4.8.0
    container_name: fuseki
    platform: linux/amd64
    ports:
      - "9030:3030"
    volumes:
      - ./fuseki/config.ttl:/fuseki/config.ttl
      - ./fuseki/shiro.ini:/fuseki/shiro.ini
      - ./fuseki/databases:/fuseki/databases
    networks:
      - sie-network

  # chromadb:
  #   # Disabled: Local ChromaDB inside sie-embedding (PersistentClient)
  #   # Keeping placeholder for future standalone mode
  #   image: chromadb/chroma:0.0.0
  #   container_name: chromadb-disabled
  #   ports:
  #     - "9040:8000"
  #   networks:
  #     - sie-network

  # init-chroma:
  #   image: python:3.11-slim
  #   container_name: init-chroma
  #   environment:
  #     CHROMA_URL: "http://sie-embedding:8081"
  #     # OPENAI_API_KEY: "${OPENAI_API_KEY}"
  #   volumes:
  #     - ./init/init-chroma.py:/init-chroma.py
  #   entrypoint: ["python", "/init-chroma.py"]
  #   depends_on:
  #     - chromadb
  #   networks:
  #     - sie-network

  # ------------------------------------------------------------
  # GraphDB Initialization (DEV)
  # ------------------------------------------------------------
  init-fuseki:
    image: curlimages/curl:8.10.1
    container_name: init-fuseki
    restart: "no"
    depends_on:
      - fuseki
    volumes:
      - ./init/init-fuseki.sh:/init-fuseki.sh
    entrypoint: ["/bin/sh", "/init-fuseki.sh"]
    networks:
      - sie-network

  # ------------------------------------------------------------
  # VectorDB / Embedding Service
  # ------------------------------------------------------------
  sie-embedding:
    build: ./src/main/python/embedding
    container_name: sie-embedding
    ports:
      - "8081:8081"
    volumes:
      # Persist Chroma data to host ./chroma-data (must match chroma_server.py persist path)
      - ./chroma-data:/chroma-data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 5s
      timeout: 2s
      retries: 20
      start_period: 5s
    depends_on:
      init-fuseki:
        condition: service_completed_successfully
    networks:
      - sie-network

# volumes:
#  chroma_data:

networks:
  sie-network:
